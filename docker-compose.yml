services:
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    volumes:
      - .:/app  # –º–æ–Ω—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    depends_on:
      db:
        condition: service_healthy  # –ñ–¥–∞—Ç—å, –ø–æ–∫–∞ db –Ω–µ –±—É–¥–µ—Ç "healthy"
      redis:
        condition: service_started # redis –æ–±—ã—á–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –≥–æ—Ç–æ–≤
    environment:
      - DATABASE_URL=postgresql+asyncpg://micro_mission:password@db:5432/micro_mission
      - REDIS_URL=redis://redis:6379
    restart: unless-stopped
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º literal block scalar –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
    command: |
      sh -c "
      echo 'üîÑ Applying migrations...' &&
      alembic upgrade head &&
      echo '‚úÖ Migrations applied' &&
      sleep 2 &&
      echo 'üöÄ Starting bot...' &&
      python -m bot.main
      "


  db:
    image: postgres:15
    environment:
      POSTGRES_DB: micro_mission
      POSTGRES_USER: micro_mission
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–º
    ports:
      - "5432:5432"
    restart: unless-stopped
    # –î–æ–±–∞–≤–ª—è–µ–º healthcheck –¥–ª—è PostgreSQL
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U micro_mission -d micro_mission"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s # –í—Ä–µ–º—è, –≤ —Ç–µ—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–≥–æ healthcheck –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –ø–æ–º–µ—Ç–∫–∏ –∫–∞–∫ unhealthy

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: unless-stopped
    # –î–æ–±–∞–≤–ª—è–µ–º healthcheck –¥–ª—è redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

volumes:
  postgres_data: # –û–±—ä—è–≤–ª—è–µ–º —Ç–æ–º –∫–∞–∫ mapping, –∏—Å–ø–æ–ª—å–∑—É—è –¥–≤–æ–µ—Ç–æ—á–∏–µ